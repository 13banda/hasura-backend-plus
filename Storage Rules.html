<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Storage Rules | Hasura Backend Plus Documentation</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/hasura-backend-plus/assets/css/0.styles.4fd46d76.css" as="style"><link rel="preload" href="/hasura-backend-plus/assets/js/app.f063d575.js" as="script"><link rel="preload" href="/hasura-backend-plus/assets/js/2.e43a4125.js" as="script"><link rel="preload" href="/hasura-backend-plus/assets/js/6.af50bf2a.js" as="script"><link rel="prefetch" href="/hasura-backend-plus/assets/js/10.e57fef85.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/11.6eaadebc.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/3.2b1cc62f.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/4.fe461acd.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/5.08823d57.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/7.0bed117e.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/8.19f01dd4.js"><link rel="prefetch" href="/hasura-backend-plus/assets/js/9.12da340d.js">
    <link rel="stylesheet" href="/hasura-backend-plus/assets/css/0.styles.4fd46d76.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/hasura-backend-plus/" class="home-link router-link-active"><img src="logo.png" alt="Hasura Backend Plus Documentation" class="logo"> <span class="site-name can-hide">Hasura Backend Plus Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/hasura-backend-plus/guide/" class="nav-link">
  Getting started
</a></div><div class="nav-item"><a href="/hasura-backend-plus/configuration/" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="/hasura-backend-plus/api/" class="nav-link">
  API
</a></div> <a href="https://github.com/nhost/hasura-backend-plus" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/hasura-backend-plus/guide/" class="nav-link">
  Getting started
</a></div><div class="nav-item"><a href="/hasura-backend-plus/configuration/" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="/hasura-backend-plus/api/" class="nav-link">
  API
</a></div> <a href="https://github.com/nhost/hasura-backend-plus" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/hasura-backend-plus/guide.html" class="sidebar-link">Getting started</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#installation" class="sidebar-link">Installation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#nhost" class="sidebar-link">Nhost</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#docker-compose" class="sidebar-link">Docker-Compose</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#standalone" class="sidebar-link">Standalone</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#registration" class="sidebar-link">Registration</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#login" class="sidebar-link">Login</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#multi-factor-authentication" class="sidebar-link">Multi-Factor Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#generate" class="sidebar-link">Generate</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#enable" class="sidebar-link">Enable</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#login-2" class="sidebar-link">Login</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#disable" class="sidebar-link">Disable</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#jwt" class="sidebar-link">JWT</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#enable-an-oauth-provider" class="sidebar-link">Enable an OAuth provider</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#change-email" class="sidebar-link">Change email</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#reset-password" class="sidebar-link">Reset password</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#unregister" class="sidebar-link">Unregister</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/guide.html#logout" class="sidebar-link">Logout</a></li></ul></li><li><a href="/hasura-backend-plus/configuration.html" class="sidebar-link">Configuration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#general" class="sidebar-link">General</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#connect-to-hasura" class="sidebar-link">Connect to Hasura</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#configure-jwt" class="sidebar-link">Configure JWT</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#migrations" class="sidebar-link">Migrations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#apply-migrations-for-a-new-installation" class="sidebar-link">Apply migrations for a new installation</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#migrating-from-hbp-v1" class="sidebar-link">Migrating from HBP v1</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#experimental" class="sidebar-link">Experimental</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#registration" class="sidebar-link">Registration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#activate-accounts" class="sidebar-link">Activate accounts</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#limit-email-domains" class="sidebar-link">Limit email domains</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#password-constraints" class="sidebar-link">Password constraints</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#additional-registration-fields" class="sidebar-link">Additional registration fields</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#authentication" class="sidebar-link">Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#oauth-providers" class="sidebar-link">OAuth Providers</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#two-factor-authentication" class="sidebar-link">Two-factor Authentication</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#enable-emails" class="sidebar-link">Enable emails</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#custom-configuration-files" class="sidebar-link">Custom configuration files</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#storage-rules" class="sidebar-link">Storage Rules</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#email-templates" class="sidebar-link">Email templates</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#private-key" class="sidebar-link">Private key</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#custom-user-schema" class="sidebar-link">Custom User Schema</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#rate-limiting" class="sidebar-link">Rate limiting</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#environment-variables" class="sidebar-link">Environment Variables</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#general-2" class="sidebar-link">General</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#authentication-2" class="sidebar-link">Authentication</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/configuration.html#storage" class="sidebar-link">Storage</a></li></ul></li></ul></li><li><a href="/hasura-backend-plus/api.html" class="sidebar-link">API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#authentication" class="sidebar-link">Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#registration" class="sidebar-link">Registration</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#login" class="sidebar-link">Login</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#logout" class="sidebar-link">Logout</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#jwk" class="sidebar-link">JWK</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#activate-account" class="sidebar-link">Activate account</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#delete-account" class="sidebar-link">Delete Account</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#change-password" class="sidebar-link">Change password</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#change-password-request" class="sidebar-link">Change Password Request</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#change-password-change" class="sidebar-link">Change Password Change</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#change-email" class="sidebar-link">Change Email</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#change-email-request" class="sidebar-link">Change Email Request</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#change-email-change" class="sidebar-link">Change Email Change</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#refresh-token" class="sidebar-link">Refresh token</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#revoke-refresh-token" class="sidebar-link">Revoke Refresh Token</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#generate-mfa-qr-code" class="sidebar-link">Generate MFA QR code</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#enable-mfa" class="sidebar-link">Enable MFA</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#disable-mfa" class="sidebar-link">Disable MFA</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#totp" class="sidebar-link">TOTP</a></li></ul></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#storage" class="sidebar-link">Storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#file" class="sidebar-link">File</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#file-metadata" class="sidebar-link">File metadata</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#file-directory" class="sidebar-link">File directory</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#file-directory-metadata" class="sidebar-link">File directory metadata</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#upload-file" class="sidebar-link">Upload file</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#delete-file" class="sidebar-link">Delete file</a></li><li class="sidebar-sub-header"><a href="/hasura-backend-plus/api.html#health-check" class="sidebar-link">Health Check</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="storage-rules"><a href="#storage-rules" class="header-anchor">#</a> Storage Rules</h1> <p>File authorization is tricky to manage, and means developers need to spend a lot of time on authentication and authorization. Using Hasura Backend Plus means all this complex code is done for you! All you need to do is set out file access rules, which makes creating and updating rules easy to manage.</p> <p>The rules are set in a <code>yaml</code> file, and let you control granular access to files and folders. Hasura Backend Plus comes with a <a href="https://github.com/nhost/hasura-backend-plus/blob/master/custom/storage-rules/rules.yaml" target="_blank" rel="noopener noreferrer">rules template<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which you can change for your specific project:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">isAuthenticated</span><span class="token punctuation">:</span> <span class="token string">'return !!request.auth'</span>
  <span class="token key atrule">isOwner</span><span class="token punctuation">:</span> <span class="token string">&quot;return !!request.auth &amp;&amp; userId === request.auth['user-id']&quot;</span>
  <span class="token key atrule">validToken</span><span class="token punctuation">:</span> <span class="token string">'return request.query.token === resource.Metadata.token'</span>
<span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/user/:userId/</span><span class="token punctuation">:</span>
    <span class="token key atrule">list</span><span class="token punctuation">:</span> <span class="token string">'isOwner(userId)'</span>
  <span class="token key atrule">/user/:userId/:fileId</span><span class="token punctuation">:</span>
    <span class="token key atrule">read</span><span class="token punctuation">:</span> <span class="token string">'isOwner(userId) || validToken()'</span>
    <span class="token key atrule">write</span><span class="token punctuation">:</span> <span class="token string">'isOwner(userId)'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>The <code>yaml</code> file is split into the following sections:</p> <ul><li><a href="#paths">Paths</a></li> <li><a href="#functions">Functions</a></li></ul> <hr> <h2 id="paths"><a href="#paths" class="header-anchor">#</a> Paths</h2> <p>Paths allow you to define authorization permissions to your folders and files. This means you can control access to files, folders, and subfolders easily.</p> <p>Paths can be static or dynamic, and dynamic paths can be used as variables within functions.</p> <h3 id="folder-paths"><a href="#folder-paths" class="header-anchor">#</a> Folder paths</h3> <p>Folder paths</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/user/:userId/files/</span><span class="token punctuation">:</span>
    <span class="token comment"># Rules</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>Note the trailing slash</strong>. This is how you define folder paths.</p> <p>You can use this to add permissions to listing files in a directory or downloading a <code>.zip</code> file of all the files.</p> <h3 id="file-paths"><a href="#file-paths" class="header-anchor">#</a> File paths</h3> <p>File paths define rules for the individual files within your storage.</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/user/:userId/files/:fileId</span><span class="token punctuation">:</span>
    <span class="token comment"># Rules</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Here, the <code>/user</code> and <code>/files</code> parts are static paths. The <code>:userId</code> and <code>:fileId</code> parts are dynamic paths.</p> <p>Here's an example path that would be validated by this rule:</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>/user/1/files/image.png
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="rules"><a href="#rules" class="header-anchor">#</a> Rules</h2> <p>You can specify the following rules in your <code>rules.yaml</code> file:</p> <table><thead><tr><th>Action</th> <th>Metadata (<code>/m/</code>)</th> <th>Object (<code>/o/</code>)</th></tr></thead> <tbody><tr><td>Folder: <code>create</code></td> <td>N/A</td> <td>N/A</td></tr> <tr><td>Folder: <code>update</code></td> <td>N/A</td> <td>N/A</td></tr> <tr><td>Folder: <code>list</code></td> <td>Get metadata for accessible files</td> <td>Get <code>.zip</code> folder of accessible files</td></tr> <tr><td>Folder: <code>get</code></td> <td>N/A</td> <td>N/A</td></tr> <tr><td>Folder: <code>delete</code></td> <td>N/A</td> <td>N/A</td></tr> <tr><td></td> <td></td> <td></td></tr> <tr><td>File: <code>create</code></td> <td>N/A</td> <td>Create file</td></tr> <tr><td>File: <code>update</code></td> <td>Update metadata</td> <td>Update file</td></tr> <tr><td>File: <code>list</code></td> <td>N/A</td> <td>N/A</td></tr> <tr><td>File: <code>get</code></td> <td>Get file metadata</td> <td>Get file</td></tr> <tr><td>File: <code>delete</code></td> <td>N/A</td> <td>Delete the file</td></tr></tbody></table> <p>For simple allow/deny, you can return boolean values (<code>true</code>/<code>false</code>) in a string.</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/public</span><span class="token punctuation">:</span>
    <span class="token key atrule">list</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
  <span class="token key atrule">/private</span><span class="token punctuation">:</span>
    <span class="token key atrule">list</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>For any complex permissions using variables, you should use <a href="#functions">functions</a>.</p> <h3 id="file-tokens"><a href="#file-tokens" class="header-anchor">#</a> File tokens</h3> <p>When you upload a file to Hasura Backend Plus, a token is automatically added to the file metadata. This is unique for the file, and can be used as an access token.
You can create a <code>validToken</code> function, and use that to allow access to the file, even if a user is unauthenticated.</p> <p>We can define a rule to allow access to this image if the right token (in this case <code>c9aa7344-1b4c-42d2-81c0-48ee401a3eeb</code>) is present:</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>/storage/o/private/secret-image.jpg?token=c9aa7344-1b4c-42d2-81c0-48ee401a3eeb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The token is sent as a query parameter, which you can access on the <code>request</code> object. You can check the token against the <code>resource.Metadata.token</code> variable:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">validToken</span><span class="token punctuation">:</span> <span class="token string">'return request.query.token === resource.Metadata.token'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>You can now use the <code>validToken</code> function to allow anyone to see the file with the correct token:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">validToken</span><span class="token punctuation">:</span> <span class="token string">'return request.query.token === resource.Metadata.token'</span>
<span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/private/:fileId</span><span class="token punctuation">:</span>
    <span class="token key atrule">read</span><span class="token punctuation">:</span> <span class="token string">'validToken()'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="functions"><a href="#functions" class="header-anchor">#</a> Functions</h2> <blockquote><p>It is not possible to call functions inside other functions</p></blockquote> <p>Functions allow you to define permissions which can be used by any rules. Functions have access to the query string of the request, and the permission variables cookie returned by the <a href="/hasura-backend-plus/api.html#login">login</a> or <a href="/hasura-backend-plus/api.html#refresh-token">refresh</a> endpoints.</p> <p>You can have a look at the permission variables by examining the <code>permission_variables</code> cookie. This is a URL-encoded string, in the following template:</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>s:&lt;request.auth&gt;.&lt;checksum&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The <code>request.auth</code> part is a JSON object, which is the same as the <a href="https://hasura.io/docs/1.0/graphql/manual/auth/authentication/index.html#overview" target="_blank" rel="noopener noreferrer">Hasura permission variables<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> but with the <code>x-hasura-</code> prefix removed:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;user-id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;73f5d02c-484a-4003-98e4-bad5c6001882&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;allowed-roles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;user&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;default-role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>You can access these variables through <code>request.auth</code> (for example <code>request.auth['default-role']</code>) when creating your storage rules.</p> <p>A simple function would be to test if a user is authenticated. You can do this by checking if <code>request.auth</code> is present:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">isAuthenticated</span><span class="token punctuation">:</span> <span class="token string">'return !!request.auth'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Now, you can use this function within a storage path:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">isAuthenticated</span><span class="token punctuation">:</span> <span class="token string">'return !!request.auth'</span>
<span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/everyone/</span><span class="token punctuation">:</span>
    <span class="token key atrule">list</span><span class="token punctuation">:</span> 'isAuthenticated()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>This will allow any logged-in user to access the files in the <code>/everyone/</code> directory. If someone isn't logged in, they won't be able to see them.</p> <p>You can also add more complex rules. For example, if you would like to allow users to access files within a folder named as their user id, you can add the following function:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">isOwner</span><span class="token punctuation">:</span> <span class="token string">'return !!request.auth &amp;&amp; request.auth[&quot;user-id&quot;] === userId'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>This function checks that a user is logged in, but also uses a variable called <code>userId</code>, which must be passed in by the rule from a <a href="#folder-paths">dynamic path</a>:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">isOwner</span><span class="token punctuation">:</span> <span class="token string">'return !!request.auth &amp;&amp; request.auth[&quot;user-id&quot;] === userId'</span>
<span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/:userId/</span><span class="token punctuation">:</span>
    <span class="token key atrule">list</span><span class="token punctuation">:</span> <span class="token string">'isOwner(userId)'</span>
  <span class="token key atrule">/:userId/:fileId</span><span class="token punctuation">:</span>
    <span class="token key atrule">read</span><span class="token punctuation">:</span> <span class="token string">'isOwner(userId)'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This rule will allow users to list their own file directory, and read their own files.</p> <h2 id="adding-variables"><a href="#adding-variables" class="header-anchor">#</a> Adding variables</h2> <p>Say you have many users that belong to different companies. You need to allow users to see files belonging to their own company, but not files belonging to other companies.</p> <p>You will need a <code>company_id</code> column on your <code>users</code> table, and from this we can add appropriate permissions.</p> <p>First, you need to add this column to the authentication permission variables, so that the <code>request.auth</code> now contains this variable:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;user-id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;73f5d02c-484a-4003-98e4-bad5c6001882&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;allowed-roles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;user&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;default-role&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;company-id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e04567bf-884d-46f0-898e-bac1a260e128&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Now, you can add the following functions to your <code>rules.yaml</code>:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">employedBy</span><span class="token punctuation">:</span> <span class="token string">'return !!request.auth &amp;&amp; request.auth[&quot;company-id&quot;] === companyId'</span>
<span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/:companyId/</span><span class="token punctuation">:</span>
    <span class="token key atrule">list</span><span class="token punctuation">:</span> <span class="token string">'employedBy(companyId)'</span>
  <span class="token key atrule">/:companyId/:fileId</span><span class="token punctuation">:</span>
    <span class="token key atrule">read</span><span class="token punctuation">:</span> <span class="token string">'employedBy(companyId) &amp;&amp; validToken()'</span>
    <span class="token key atrule">write</span><span class="token punctuation">:</span> <span class="token string">'employedBy(companyId)'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>How does this work? The <code>:companyId</code> path creates a variable called <code>companyId</code>, which can be passed into a function.
This gets passed into the <code>employedBy()</code> function, (called <code>companyId</code>), and can be compared to <code>request.auth['company-id']</code> from the <code>permission_variables</code> cookie.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/nhost/hasura-backend-plus/edit/master/Storage Rules.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/8/2020, 10:21:58 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/hasura-backend-plus/assets/js/app.f063d575.js" defer></script><script src="/hasura-backend-plus/assets/js/2.e43a4125.js" defer></script><script src="/hasura-backend-plus/assets/js/6.af50bf2a.js" defer></script>
  </body>
</html>
