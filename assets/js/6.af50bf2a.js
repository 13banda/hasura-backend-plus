(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{331:function(s,t,a){"use strict";a.r(t);var e=a(18),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"storage-rules"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#storage-rules"}},[s._v("#")]),s._v(" Storage Rules")]),s._v(" "),a("p",[s._v("File authorization is tricky to manage, and means developers need to spend a lot of time on authentication and authorization. Using Hasura Backend Plus means all this complex code is done for you! All you need to do is set out file access rules, which makes creating and updating rules easy to manage.")]),s._v(" "),a("p",[s._v("The rules are set in a "),a("code",[s._v("yaml")]),s._v(" file, and let you control granular access to files and folders. Hasura Backend Plus comes with a "),a("a",{attrs:{href:"https://github.com/nhost/hasura-backend-plus/blob/master/custom/storage-rules/rules.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("rules template"),a("OutboundLink")],1),s._v(", which you can change for your specific project:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("isAuthenticated")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return !!request.auth'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("isOwner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"return !!request.auth && userId === request.auth['user-id']\"")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("validToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return request.query.token === resource.Metadata.token'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/user/:userId/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isOwner(userId)'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/user/:userId/:fileId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isOwner(userId) || validToken()'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isOwner(userId)'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("The "),a("code",[s._v("yaml")]),s._v(" file is split into the following sections:")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#paths"}},[s._v("Paths")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#functions"}},[s._v("Functions")])])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"paths"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#paths"}},[s._v("#")]),s._v(" Paths")]),s._v(" "),a("p",[s._v("Paths allow you to define authorization permissions to your folders and files. This means you can control access to files, folders, and subfolders easily.")]),s._v(" "),a("p",[s._v("Paths can be static or dynamic, and dynamic paths can be used as variables within functions.")]),s._v(" "),a("h3",{attrs:{id:"folder-paths"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#folder-paths"}},[s._v("#")]),s._v(" Folder paths")]),s._v(" "),a("p",[s._v("Folder paths")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/user/:userId/files/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Rules")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("strong",[s._v("Note the trailing slash")]),s._v(". This is how you define folder paths.")]),s._v(" "),a("p",[s._v("You can use this to add permissions to listing files in a directory or downloading a "),a("code",[s._v(".zip")]),s._v(" file of all the files.")]),s._v(" "),a("h3",{attrs:{id:"file-paths"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#file-paths"}},[s._v("#")]),s._v(" File paths")]),s._v(" "),a("p",[s._v("File paths define rules for the individual files within your storage.")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/user/:userId/files/:fileId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Rules")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("Here, the "),a("code",[s._v("/user")]),s._v(" and "),a("code",[s._v("/files")]),s._v(" parts are static paths. The "),a("code",[s._v(":userId")]),s._v(" and "),a("code",[s._v(":fileId")]),s._v(" parts are dynamic paths.")]),s._v(" "),a("p",[s._v("Here's an example path that would be validated by this rule:")]),s._v(" "),a("div",{staticClass:"language-txt line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/user/1/files/image.png\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"rules"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rules"}},[s._v("#")]),s._v(" Rules")]),s._v(" "),a("p",[s._v("You can specify the following rules in your "),a("code",[s._v("rules.yaml")]),s._v(" file:")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Action")]),s._v(" "),a("th",[s._v("Metadata ("),a("code",[s._v("/m/")]),s._v(")")]),s._v(" "),a("th",[s._v("Object ("),a("code",[s._v("/o/")]),s._v(")")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("Folder: "),a("code",[s._v("create")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("N/A")])]),s._v(" "),a("tr",[a("td",[s._v("Folder: "),a("code",[s._v("update")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("N/A")])]),s._v(" "),a("tr",[a("td",[s._v("Folder: "),a("code",[s._v("list")])]),s._v(" "),a("td",[s._v("Get metadata for accessible files")]),s._v(" "),a("td",[s._v("Get "),a("code",[s._v(".zip")]),s._v(" folder of accessible files")])]),s._v(" "),a("tr",[a("td",[s._v("Folder: "),a("code",[s._v("get")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("N/A")])]),s._v(" "),a("tr",[a("td",[s._v("Folder: "),a("code",[s._v("delete")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("N/A")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td"),s._v(" "),a("td")]),s._v(" "),a("tr",[a("td",[s._v("File: "),a("code",[s._v("create")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("Create file")])]),s._v(" "),a("tr",[a("td",[s._v("File: "),a("code",[s._v("update")])]),s._v(" "),a("td",[s._v("Update metadata")]),s._v(" "),a("td",[s._v("Update file")])]),s._v(" "),a("tr",[a("td",[s._v("File: "),a("code",[s._v("list")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("N/A")])]),s._v(" "),a("tr",[a("td",[s._v("File: "),a("code",[s._v("get")])]),s._v(" "),a("td",[s._v("Get file metadata")]),s._v(" "),a("td",[s._v("Get file")])]),s._v(" "),a("tr",[a("td",[s._v("File: "),a("code",[s._v("delete")])]),s._v(" "),a("td",[s._v("N/A")]),s._v(" "),a("td",[s._v("Delete the file")])])])]),s._v(" "),a("p",[s._v("For simple allow/deny, you can return boolean values ("),a("code",[s._v("true")]),s._v("/"),a("code",[s._v("false")]),s._v(") in a string.")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/public")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/private")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'false'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("For any complex permissions using variables, you should use "),a("a",{attrs:{href:"#functions"}},[s._v("functions")]),s._v(".")]),s._v(" "),a("h3",{attrs:{id:"file-tokens"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#file-tokens"}},[s._v("#")]),s._v(" File tokens")]),s._v(" "),a("p",[s._v("When you upload a file to Hasura Backend Plus, a token is automatically added to the file metadata. This is unique for the file, and can be used as an access token.\nYou can create a "),a("code",[s._v("validToken")]),s._v(" function, and use that to allow access to the file, even if a user is unauthenticated.")]),s._v(" "),a("p",[s._v("We can define a rule to allow access to this image if the right token (in this case "),a("code",[s._v("c9aa7344-1b4c-42d2-81c0-48ee401a3eeb")]),s._v(") is present:")]),s._v(" "),a("div",{staticClass:"language-txt line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/storage/o/private/secret-image.jpg?token=c9aa7344-1b4c-42d2-81c0-48ee401a3eeb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("The token is sent as a query parameter, which you can access on the "),a("code",[s._v("request")]),s._v(" object. You can check the token against the "),a("code",[s._v("resource.Metadata.token")]),s._v(" variable:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("validToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return request.query.token === resource.Metadata.token'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("You can now use the "),a("code",[s._v("validToken")]),s._v(" function to allow anyone to see the file with the correct token:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("validToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return request.query.token === resource.Metadata.token'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/private/:fileId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'validToken()'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"functions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#functions"}},[s._v("#")]),s._v(" Functions")]),s._v(" "),a("blockquote",[a("p",[s._v("It is not possible to call functions inside other functions")])]),s._v(" "),a("p",[s._v("Functions allow you to define permissions which can be used by any rules. Functions have access to the query string of the request, and the permission variables cookie returned by the "),a("RouterLink",{attrs:{to:"/api.html#login"}},[s._v("login")]),s._v(" or "),a("RouterLink",{attrs:{to:"/api.html#refresh-token"}},[s._v("refresh")]),s._v(" endpoints.")],1),s._v(" "),a("p",[s._v("You can have a look at the permission variables by examining the "),a("code",[s._v("permission_variables")]),s._v(" cookie. This is a URL-encoded string, in the following template:")]),s._v(" "),a("div",{staticClass:"language-txt line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("s:<request.auth>.<checksum>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("The "),a("code",[s._v("request.auth")]),s._v(" part is a JSON object, which is the same as the "),a("a",{attrs:{href:"https://hasura.io/docs/1.0/graphql/manual/auth/authentication/index.html#overview",target:"_blank",rel:"noopener noreferrer"}},[s._v("Hasura permission variables"),a("OutboundLink")],1),s._v(" but with the "),a("code",[s._v("x-hasura-")]),s._v(" prefix removed:")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"user-id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"73f5d02c-484a-4003-98e4-bad5c6001882"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"allowed-roles"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"default-role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("You can access these variables through "),a("code",[s._v("request.auth")]),s._v(" (for example "),a("code",[s._v("request.auth['default-role']")]),s._v(") when creating your storage rules.")]),s._v(" "),a("p",[s._v("A simple function would be to test if a user is authenticated. You can do this by checking if "),a("code",[s._v("request.auth")]),s._v(" is present:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("isAuthenticated")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return !!request.auth'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("Now, you can use this function within a storage path:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("isAuthenticated")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return !!request.auth'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/everyone/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 'isAuthenticated()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("This will allow any logged-in user to access the files in the "),a("code",[s._v("/everyone/")]),s._v(" directory. If someone isn't logged in, they won't be able to see them.")]),s._v(" "),a("p",[s._v("You can also add more complex rules. For example, if you would like to allow users to access files within a folder named as their user id, you can add the following function:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("isOwner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return !!request.auth && request.auth[\"user-id\"] === userId'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("This function checks that a user is logged in, but also uses a variable called "),a("code",[s._v("userId")]),s._v(", which must be passed in by the rule from a "),a("a",{attrs:{href:"#folder-paths"}},[s._v("dynamic path")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("isOwner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return !!request.auth && request.auth[\"user-id\"] === userId'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/:userId/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isOwner(userId)'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/:userId/:fileId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isOwner(userId)'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("This rule will allow users to list their own file directory, and read their own files.")]),s._v(" "),a("h2",{attrs:{id:"adding-variables"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#adding-variables"}},[s._v("#")]),s._v(" Adding variables")]),s._v(" "),a("p",[s._v("Say you have many users that belong to different companies. You need to allow users to see files belonging to their own company, but not files belonging to other companies.")]),s._v(" "),a("p",[s._v("You will need a "),a("code",[s._v("company_id")]),s._v(" column on your "),a("code",[s._v("users")]),s._v(" table, and from this we can add appropriate permissions.")]),s._v(" "),a("p",[s._v("First, you need to add this column to the authentication permission variables, so that the "),a("code",[s._v("request.auth")]),s._v(" now contains this variable:")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"user-id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"73f5d02c-484a-4003-98e4-bad5c6001882"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"allowed-roles"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"default-role"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"company-id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"e04567bf-884d-46f0-898e-bac1a260e128"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("Now, you can add the following functions to your "),a("code",[s._v("rules.yaml")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("functions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("employedBy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'return !!request.auth && request.auth[\"company-id\"] === companyId'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/:companyId/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'employedBy(companyId)'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("/:companyId/:fileId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'employedBy(companyId) && validToken()'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'employedBy(companyId)'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("How does this work? The "),a("code",[s._v(":companyId")]),s._v(" path creates a variable called "),a("code",[s._v("companyId")]),s._v(", which can be passed into a function.\nThis gets passed into the "),a("code",[s._v("employedBy()")]),s._v(" function, (called "),a("code",[s._v("companyId")]),s._v("), and can be compared to "),a("code",[s._v("request.auth['company-id']")]),s._v(" from the "),a("code",[s._v("permission_variables")]),s._v(" cookie.")])])}),[],!1,null,null,null);t.default=n.exports}}]);